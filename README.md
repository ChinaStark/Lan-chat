# Lan-Chat 应用 README

这是一个基于现代安卓技术栈构建的本地局域网（LAN）实时聊天应用。项目旨在展示如何利用最新的 Jetpack 库和最佳实践来构建一个功能完整、架构清晰、性能优异且高度健壮的应用程序。

## 产品功能介绍

Lan-Chat 是一款轻量级的局域网内即时通讯工具，让您在同一个 Wi-Fi 网络下，无需连接互联网，即可与朋友和同事进行快速、安全地沟通。

*   **个性化昵称设置**: 用户首次使用需设定专属昵称，作为您在聊天中的唯一身份标识。
*   **实时文本聊天**: 在同一网络下，与朋友进行毫秒级的即时消息沟通。
*   **丰富媒体共享**: 不仅支持文字，还可以轻松地分享相册中的图片和手机存储中的各类文件。
*   **清晰的消息界面**: 采用现代化的气泡对话形式，清晰地区分自己与他人的消息，并显示发送者昵称与时间，让沟通一目了然。

## 程序概要设计

本应用遵循 Google 官方推荐的**现代化安卓应用架构**，以 **MVVM (Model-View-ViewModel)** 作为核心设计模式，实现了严格的关注点分离和单向数据流（Unidirectional Data Flow）。

![MVVM Architecture](https://developer.android.com/topic/libraries/architecture/images/mad-arch-overview.png)

1.  **View (视图层)**
    *   **技术**: 完全由 **Jetpack Compose** 构建，无任何 XML。
    *   **职责**: 视图层是用户直接交互的界面。`MainActivity` 作为 UI 的主入口和宿主，它本身不包含任何业务逻辑。其核心职责是观察 `ViewModel` 暴露的状态，并根据这些状态“声明式”地决定渲染 `UserProfileScreen`（当用户未设置昵称时）还是 `ChatScreen`（当用户已设置昵称时）。所有 Composable 函数都只负责将 `ViewModel` 的状态转化为用户可见的 UI，并捕获用户的输入事件（如点击、文本输入），将这些事件通知给 `ViewModel` 处理。

2.  **ViewModel (视图模型)**
    *   **技术**: `AndroidX ViewModel` 结合 `Kotlin Coroutines` 和 `StateFlow`。
    *   **职责**: `ChatViewModel` 是 UI 的“大脑”，是视图层与模型层的桥梁。它持有并管理 UI 所需的所有状态（如消息列表 `messages`、连接状态 `isConnected` 等），并以响应式的 `StateFlow` 形式将这些状态暴露给 UI 层。它负责处理所有业务逻辑，例如拼接发送的消息、调用仓库上传文件、以及最重要的**网络重连策略**。由于 `ViewModel` 具有生命周期感知能力，它可以在屏幕旋转等配置变更后依然存活，保证了应用状态的一致性。

3.  **Model (模型层)**
    *   **技术**: 采用 **Repository (仓库) 模式**对数据来源进行封装和抽象。
    *   **职责**: `ChatRepository` 是 `ViewModel` 的唯一数据来源，它为 `ViewModel` 提供了一个干净、统一的数据 API，同时屏蔽了底层具体的数据获取方式，使得 `ViewModel` 无需关心数据究竟是来自网络、本地数据库还是缓存。
        *   **网络数据源**:
            *   `WebSocketManager`: 使用 OkHttp 实现，负责处理核心的实时消息收发。它维护一个持久的 WebSocket 连接，用于低延迟、双向的实时通信。
            *   `RetrofitClient`: 负责处理传统的“请求-响应”式 RESTful API 调用。在本项目中，它被设计用来处理文件上传/下载这类一次性的、基于 HTTP 的数据传输。
        *   **本地数据源**:
            *   `UserPreferences`: 使用 Android 的 `SharedPreferences` 实现，负责对用户的昵称等简单配置信息进行持久化存储。

**数据流**:
数据遵循严格的**单向流动**原则：数据从 **Model** 层（数据源）流向 **ViewModel**（在这里进行处理与整合），最终由 **View**（UI）订阅 `ViewModel` 的 `StateFlow` 并将状态渲染出来。用户的交互事件则反向流动：从 **View** 传递给 **ViewModel`，再由 `ViewModel** 调用 **Model** 层执行相应的数据操作，操作结果又会通过 `StateFlow` 更新，再次驱动 UI 刷新。这个闭环确保了数据的可预测性和易于调试。

## 技术亮点

*   **健壮的网络连接管理**: 移动应用的网络环境极其不稳定，简单的连接逻辑无法满足现实需求。本项目在 `ChatViewModel` 中实现了一套生产级别的重连策略，它是一个多层次的防御体系：
    1.  **自动触发**: 当应用进入前台或网络连接意外断开时，会自动启动重连“管家”。
    2.  **限时重试**: “管家”会在一个2分钟的时间窗口内，持续地、每隔数秒尝试重新连接，以应对网络短暂的波动或“假死”状态。
    3.  **超时机制**: 如果2分钟后依然无法连接成功（例如用户进入了电梯），“管家”会停止自动尝试，以避免不必要的电量消耗。
    4.  **用户控制**: 在超时后，UI上会显示一个明确的“点击重试”按钮，将最终的控制权交还给用户，提供了清晰的故障反馈和恢复路径。

*   **混合网络模型**: 针对不同的通信场景，项目聪明地结合了两种最合适的网络技术，实现了性能和稳定性的最优化：
    *   **WebSocket (用于实时通信)**: 对于聊天消息这种需要极低延迟、服务器可以主动推送、客户端与服务器需要频繁双向沟通的场景，WebSocket 是不二之选。它通过维持一个长连接，避免了HTTP频繁建连的开销，保证了消息的“实时性”。
    *   **Retrofit (用于文件传输)**: 对于上传/下载图片、文件这类大数据量的、一次性的操作，传统的基于 HTTP 的 RESTful API 模式更为成熟和可靠。Retrofit 作为业界标准库，提供了强大的请求构建、序列化和错误处理机制，非常适合这种“请求-响应”式的交互。
    这种为不同场景选择最优解的“混合模式”，是构建高性能、高可靠性应用的标志。
